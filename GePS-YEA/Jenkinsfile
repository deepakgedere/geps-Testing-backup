pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    options {
        timestamps()
    }

    environment {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Repo / Branch Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        JOB_NAME           = 'GePS-YGS_YEA'
        DEVELOPMENT_BRANCH = 'master'
        TESTING_BRANCH     = 'main'
        CREDENTIALS_ID     = '813c6e55-37f7-4f42-8153-3a19b435f10b'

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build / Test Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        MAVEN_GOALS        = 'clean install -DskipTests=true'
        PROJECT_NAME       = 'GePS-YEA'
        TEST_SUITE         = "src/test/resources/testrunners/${PROJECT_NAME}_functional-test.xml"
        WORKING_DIR        = 'GePS-Testing/GePS-YEA'

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        OUTPUT_REPORT_DIR      = "${WORKING_DIR}/test-output"
        ALLURE_RESULT_DIR      = "${WORKING_DIR}/allure-results"
        ALLURE_REPORT_DIR      = "${WORKING_DIR}/allure-report"

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        GOOGLE_DRIVE_FOLDER_ID = '1dTAvaEyFH9MVhbgqSDSVOAWEiS7PmKHa'
        WAIT_TIME_SEC      = '20'
    }

    stages {

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [1] Clean Workspace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Clean Workspace') {
            steps {
                cleanWs()
                echo 'âœ… Workspace cleaned.'
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€ [2] Parallel Git Checkouts (Development & Testing Repos) â”€â”€â”€â”€â”€â”€â”€
        stage('Parallel Checkout Repositories') {
            parallel {
                stage('Checkout Development Repository (GePS)') {
                    steps {
                        timeout(time: 10, unit: 'MINUTES') {
                            retry(2) {
                                echo "ğŸ” Checking out GePS repo (GePS - YEA)..."
                                checkout([
                                    $class: 'GitSCM',
                                    branches: [[name: "${DEVELOPMENT_BRANCH}"]],
                                    extensions: [
                                        [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'GePS - YEA/']]],
                                        [$class: 'CloneOption', shallow: true, depth: 1, noTags: true, timeout: 10]
                                    ],
                                    userRemoteConfigs: [[
                                        url: 'https://github.com/CormSquare/GePS.git',
                                        credentialsId: "${CREDENTIALS_ID}"
                                    ]]
                                ])
                                echo "âœ… Checked out GePS repo directory (GePS - YEA)."
                            }
                        }
                    }
                }

                stage('Checkout Testing Repository (GePS-Testing)') {
                    steps {
                        timeout(time: 10, unit: 'MINUTES') {
                            retry(2) {
                                dir('GePS-Testing') {
                                    echo "ğŸ” Checking out GePS-Testing repo (GePS-YEA)..."
                                    checkout([
                                        $class: 'GitSCM',
                                        branches: [[name: "${TESTING_BRANCH}"]],
                                        extensions: [
                                            [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'GePS-YEA/']]],
                                            [$class: 'CloneOption', shallow: true, depth: 1, noTags: true, timeout: 10]
                                        ],
                                        userRemoteConfigs: [[
                                            url: 'https://github.com/CormSquare/GePS-Testing.git',
                                            credentialsId: "${CREDENTIALS_ID}"
                                        ]]
                                    ])
                                }
                                echo "âœ… Checked out GePS-Testing repo directory (GePS-YEA)."
                            }
                        }
                    }
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [3] Build Maven Project â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Build YEA Project') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "âš™ï¸ Building YEA Project (Skipping Tests Only for Build)..."
                    bat "mvn ${MAVEN_GOALS}"
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: "${WORKING_DIR}/target/*.jar", onlyIfSuccessful: true
                }
                failure {
                    echo "âŒ Build failed. Please check the logs."
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [4] Start Docker Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Start Selenium Grid') {
            steps {
                dir("${WORKING_DIR}") {
                    script {
                        echo "ğŸš€ Starting Selenium Grid..."
                        bat "docker-compose -f docker-compose.yaml up -d"
                        echo "â³ Waiting ${WAIT_TIME_SEC}s for Selenium Grid..."
                        bat "powershell -Command Start-Sleep -Seconds ${WAIT_TIME_SEC}"
                    }
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [5] Clear Old Allure Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Clean Old Allure Results') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "ğŸ§¹ Cleaning old allure-results before test run..."
                    bat 'rmdir /S /Q allure-results || echo "No old allure-results to delete."'
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [6] Run Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Regression Automation Test') {
            steps {
                dir("${WORKING_DIR}") {
                    timeout(time: 30, unit: 'MINUTES') {
                        echo "ğŸ§ª Running Playwright tests..."
                        bat """
                        set SELENIUM_REMOTE_URL=http://localhost:4444/wd/hub
                        mvn test -DsuiteXmlFile=${TEST_SUITE}
                        """
                    }
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
                failure {
                    echo "âŒ Test run failed."
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [7] Generate Allure Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Allure Report Generation') {
            steps {
                dir("${WORKING_DIR}") {
                    timeout(time: 5, unit: 'MINUTES') {
                        echo "ğŸ“Š Generating Allure Report..."
                        bat 'rmdir /S /Q allure-report'
                        bat "allure generate allure-results --clean -o allure-report || echo 'Allure generate failed!'"
                        bat "powershell Compress-Archive -Path 'allure-report\\*' -DestinationPath 'AllureReport.zip'"
                    }
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [8] Publish Reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Publish Reports') {
            steps {
                script {
                    if (fileExists("${ALLURE_REPORT_DIR}/index.html")) {
                        publishHTML([
                            keepAll: true,
                            alwaysLinkToLastBuild: true,
                            reportDir   : "${ALLURE_REPORT_DIR}",
                            reportFiles : 'index.html',
                            reportName  : 'AllureReport'
                        ])
                    } else {
                        echo "âš ï¸ Allure report not found."
                    }
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [9] Upload Allure Report to Google Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Upload Allure Report to Google Drive') {
            steps {
                dir("${WORKING_DIR}") {
                    script {
                        echo "â˜ï¸ Uploading Allure Report to Google Drive via rclone..."

                        def gdriveFolderName = "Build_${env.BUILD_NUMBER}"
                        def rclonePath = "C:\\My_Personal_Folder\\GePS-Testing\\R-Clone\\rclone.exe"
                        def rcloneConfig = "C:\\My_Personal_Folder\\GePS-Testing\\R-Clone\\rclone.conf"

                        bat """
                            "${rclonePath}" mkdir gdrive:${gdriveFolderName} --drive-root-folder-id ${GOOGLE_DRIVE_FOLDER_ID} --config "${rcloneConfig}"
                            "${rclonePath}" copy AllureReport.zip gdrive:${gdriveFolderName} --drive-root-folder-id ${GOOGLE_DRIVE_FOLDER_ID} --config "${rcloneConfig}" --create-empty-src-dirs
                        """
                    }
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [10] Stop Docker Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Stop Services') {
            steps {
                dir("${WORKING_DIR}") {
                    script {
                        echo "ğŸ›‘ Stopping Selenium Grid services..."
                        bat 'docker-compose -f docker-compose.yaml down'
                    }
                }
            }
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [11] Post-Build Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    post {
        failure {
            emailext(
                mimeType: 'text/html',
                to: 'test.troops@cormsquare.com',
                subject: "âŒ CI/CD Pipeline Alert - Build FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """<html>
                    <body style="font-family: Arial, sans-serif; line-height: 1.6;">
                        <h2 style="color: red;">ğŸš¨ Build Failure Notification</h2>
                        <p><strong>Job:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
                        <p><strong>Status:</strong> <span style="color:red;">FAILED</span></p>
                        <p><strong>Time:</strong> ${new Date()}</p>

                        <p>ğŸ”— <strong>Jenkins Job:</strong> <a href="${env.BUILD_URL}">View Build #${env.BUILD_NUMBER}</a></p>

                        <p>ğŸ“‚ <strong>Allure Report on Google Drive:</strong>
                        <a href="https://drive.google.com/drive/folders/${GOOGLE_DRIVE_FOLDER_ID}" target="_blank">
                        Click here (Build_${env.BUILD_NUMBER})</a></p>

                        <hr style="border-top: 1px solid #ccc;"/>

                        <p><strong>Note:</strong> To view the detailed test execution report, open <code>index.html</code> from the Drive folder using any web browser.</p>

                        <hr/>
                        <footer style="font-size: 12px; color: #888;">
                            <p>Warm Regards,</p>
                            <p><strong>Jenkins CI/CD System</strong><br>
                            QA-Team</p>
                            <p style="margin-top: 10px;"><em>ğŸ“© For any doubts or clarifications, please contact the QA team directly.</em></p>
                            <p><em>ğŸš« Please do not reply to this automated email.</em></p>
                        </footer>
                    </body>
                </html>"""
            )
        }

        success {
            emailext(
                mimeType: 'text/html',
                to: 'test.troops@cormsquare.com',
                subject: "âœ… CI/CD Pipeline Success - Build PASSED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """<html>
                    <body style="font-family: Arial, sans-serif; line-height: 1.6;">
                        <h2 style="color: green;">âœ… Build Success Notification</h2>
                        <p><strong>Job:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
                        <p><strong>Status:</strong> <span style="color:green;">SUCCESS</span></p>
                        <p><strong>Time:</strong> ${new Date()}</p>

                        <p>ğŸ”— <strong>Jenkins Job:</strong> <a href="${env.BUILD_URL}">View Build #${env.BUILD_NUMBER}</a></p>

                        <p>ğŸ“‚ <strong>Allure Report on Google Drive:</strong>
                        <a href="https://drive.google.com/drive/folders/${GOOGLE_DRIVE_FOLDER_ID}" target="_blank">
                        Click here (Build_${env.BUILD_NUMBER})</a></p>

                        <hr style="border-top: 1px solid #ccc;"/>

                        <p><strong>Note:</strong> To view the detailed test execution report, open <code>index.html</code> from the Drive folder using any web browser.</p>

                        <hr/>
                        <footer style="font-size: 12px; color: #888;">
                            <p>Warm Regards,</p>
                            <p><strong>Jenkins CI/CD System</strong><br>
                            QA-Team</p>
                            <p style="margin-top: 10px;"><em>ğŸ“© For any doubts or clarifications, please contact the QA team directly.</em></p>
                            <p><em>ğŸš« Please do not reply to this automated email.</em></p>
                        </footer>
                    </body>
                </html>"""
            )
        }

        cleanup {
            cleanWs()
        }
    }
}